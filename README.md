# Tanstack Query Study

在近期的开发工作中，遇到了管理请求&状态的复杂性问题，手动编写代码处理时遇到了层出不穷的问题，这个时候就希望有一套封装好的工具能够快速解决这些问题。

主要的对比目标是 **通过 Jotai Store + JS 手动实现**

## 问题一：请求状态

需求：管理请求中 loading、请求成功及数据 data、请求失败及错误 error

对比：需要为每个状态声明一组 loading/data/error，很麻烦。

测试结果：

- 返回的属性比较多，需要明确其意义，例如 isLoading 只是第一次加载的 loading，isFetching 才是全时期的 loading
- 只维护最近请求的结果：例如连点三下 refetch，发出三个请求，其中第一第三个请求在 2s 时成功，第二个请求在 5s 时超时，则 error 不会显示出来，而是以第三个请求的状态作为最终状态！
  - 但是貌似观察到一个不太符合预期的行为，对于历史数据 d1，同上发出三个请求，如果最后一个请求失败，哪怕前两个请求有成功的返回 d2/d3，也不会更新，数据依然保持在 d1

## 问题二：分页 + 缓存 + 定时

需求：管理分页数据，支持缓存，并且在快速换页时要保证最终一致性。

对比：需要自建缓存，最终一致性维护的逻辑比较复杂。

测试结果：

- 分页数据的管理及缓存比较易用，最终一致性跟着状态走，比较合理。
- 如果涉及到 onSuccess 的其它处理逻辑，会使 queryFn 变得不那么优雅。
- 后台定时拉取用 prefetchQuery 更好控制，用 invalidateQueries 有很多奇怪的问题，例如它会直接采用上面那个比较复杂的 queryFn 而且没地方自定义。
